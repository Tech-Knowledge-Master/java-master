# JVM
## 1. JVM 이란?
Java Virtual Machine 의 약자로 
자바 프로그램이 실행되는 환경을 제공하는 가상 머신이다.

자바 바이트 코드륵 해석하고 이를 실행하는 역할을 한다.


### - JDK vs JRE (JRE ⊃ JDK)
JRE(Java Runtime Environment) 는 컴파일된 자바 프로그램을 실행시킬 수 있는 자바 환경으로 JVM 이 이에 속한다. JVM 의 실행환경을 구현했다고 볼 수 있다.

JDK(Java Development Kit) 는 개발을 위해 필요한 도구들을 포함하며 자바 컴파일러가 이에 속한다. JDK 설치 시 JRE 도 설치된다.



### - .java vs .class
.java 파일은 자바 파일이 즉 소스 코드 파일이다. .class 파일 .java 파일을 컴파일하면 생기는 파일로 클래스 파일 혹은 자바 바이트 코드라 불린다.

자바 바이트 코드는 JVM 만 설치되어 있으면 어떤 운영체제든 상관없이 자바 언어로 작성된 코드를 실행할 수 있다.
JVM 에서는 클래스 로더를 통해 이 자바 바이트 코드를 로딩한다.

## 2. JVM 의 구조
![img_1.png](img_1.png)

## 3. JVM 구성요소
1. Class Loader
* javac 컴파일러로 컴파일된 바이트 코드를 JVM 의 Runtime Date Area 에 로드하는 모듈이다.
* 클래스 로더는 프로그램의 런타임 중에 JVM 의 메소드 영역에 동적로딩을 수행한다.
    크게 (1) `로딩` (2) `링크` (3) `초기화`의 단계를 거쳐 자바 클래스를 메모리에 적재한다.
    * 로딩: 클래스 파일을 JVM 의 메모리 영역(Runtime Data Area의 Method Area) 에 로드
    * 링크: 코드 내부의 레퍼런스를 연결하는 과정
      * 검증 vertify: .class 파일이 유효한지 검사
      * 준비 prepare: 클래스가 필요로 하는 메모리 할당, 클래스의 필드/메소드/인터페이스를 나타내는 데이터 구조 준비
      * 분석 resolve: 클래스의 상수 Pool 내 모든 심볼릭 레퍼런스를 다이렉트 레퍼런스로 변경한다.(이름에 의한 참조 -> 메모리 주소에 의한 참조)
    * 초기화: static 변수를 초기화하고 값을 할당하는 과정
* 클래스 로더 종류
  * BootStrap Class Loader:  JVM 시작 시 최초로 실행되는 클래스 로더
    - Java Class 를 로드 할 수 있는 자바 자체의 클래스 로더와 최소한의 자바 클래스(java.lang.Object/Class/ClassLoader) 만을 로드하는 역할을 수행
  
  * Extension Class Loader: 확장 자바 클래스 파일들을 로드
  * System Class Loader(Java 8 버전까지는 Application Class Loader라고 불린다.): 자바 프로그램 실행시 지정한 ClassPath에 있는 클래스 파일 혹은 jar 에 속한 클래스들을 로드
  > JVM 의 메서드 영역에 클래스가 로드되었는지확인 -> 로드 안된 경우 시스템 클래스 로더에 클래스 로드 요청 -> 확장 클래스 로더에 요청 위임 -> 부트스트랩클래스로더에 요청 위임 -> 부트 스트랩 클래스로더는 부트 스트랩에 해당 클래스 있는지 확인 후 존재하지 않으면 확장클래스 로더 요청 넘김 -> 확장 클래스 로더에 클래스 존재하지 않으면 시스템 클래스 로더에게 요청 넘김 -> 시스템
클래스 로더가 시스템 ClassPath에 해당 클래스가 있는지 확인 후 클래스가 존재하지 않는 경우 `ClassNotFoundException` 에러 발생
2. Execution Engine
   * 인터프리터
   * JIT 컴파일러: 인터프리터의 느린 단점 보완 - 반복되는 코드 발견시 바이트 코드 전체 컴파일 실행
   * 가비지 컬렉터: 힙 영역에서 사용되지 않는 메모리 회수
3. Runtime Data Area

    JVM 이 프로그램 수행위해 OS로부터 할당 받는 메모리영역이다. 
    * PC 레지스터
      * JVM의 명령어 주소를 저장한다.
    * JVM Stack
      * 각 스레드 별로 메서드 실행 시, 해당 메서드들의 실행을 위한 지역변수, 매개변수의 할당 연산을 위한 영역 - 스택프레임 구조를 지님
    * Native Method Stack
      * JNI를 통해 실행된 Native Method 들이 사용하는 스택
    * Heap
      * 인스턴스와 배열이 동적으로 생성되는 공간
      * 가비지 컬렉션의 대상이 되는 영역
      * 모든 스레드가 공유하기에 동기화 문제 발생
    * Method Area 
      * 클래스 로더가 적재한 클래스 또는 인터페이스에 대한 메타 데이터 정보가 저장된다.
      * Heap 의 PermGen 이라는 영역에 속했으나 Java 8 이후로는 Metaspace라는 OS가 관리하는 영역
4. JNI - 네이티브 메서드 인터페이스
   * 다른 언어로 만든 Application과 자바가 상호 작용할 수 있는 인터페이스를 제공
5. 네이티브 메서드 라이브러리
    * 네이티브 코드(C/C++)로 작성된 라이브러리


## 4. JVM 동작방식
1. 자바 프로그램 실행시 JVM은 OS 로 부터 메모리를 할당받는다
2. 자바 컴파일러(javac.exe : JDK 에 포함되어 있음) 가 자바 소스코드를 자바 바이트 코드로 컴파일한다.
3. 클래스로드는 동적로딩을 위해 필요한 클래스들을 로딩 및 링크하여 런타임 데이터 영역에 올린다.
4. 런타임 데이터 영역에 로딩된 바이트 코드는 Execution Engine 을 통해 해석된다. 
5. 그 과정에서 Execution Engine 에 의해 가비지 컬렉터의 작동과 스레드의 동기화가 이루어진다.
